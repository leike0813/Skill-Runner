<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Run Detail - {{ detail.request_id }}</title>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <style>
        body { font-family: "Segoe UI", sans-serif; margin: 0; background: #f7f9fc; color: #1f2937; }
        .layout { max-width: 1280px; margin: 0 auto; padding: 20px; display: grid; gap: 16px; }
        .row { display: grid; grid-template-columns: 38% 62%; gap: 16px; }
        .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 14px; }
        .meta { color: #6b7280; font-size: 13px; margin-top: 6px; }
        .tree-line { font-size: 13px; line-height: 1.7; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .dir { color: #1d4ed8; }
        .file { color: #111827; }
        a { color: #0f766e; text-decoration: none; }
        a:hover { text-decoration: underline; }
        pre { margin: 0; white-space: pre-wrap; word-break: break-word; font-size: 12px; line-height: 1.5; }
        button { border: 0; border-radius: 8px; background: #0f766e; color: #fff; padding: 8px 12px; cursor: pointer; }
        button:hover { background: #0b5f58; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .danger { background: #b91c1c; }
        .danger:hover { background: #991b1b; }
        .pane-scroll { max-height: 340px; overflow: auto; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px; }
        .conversation-window { min-height: 220px; max-height: 360px; overflow: auto; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px; }
        .chat-item { margin: 0 0 10px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 8px; background: #ffffff; }
        .chat-item.system { background: #f3f4f6; }
        .chat-item .meta { margin-top: 4px; }
        .badge-low-confidence { display: inline-block; margin-left: 8px; color: #92400e; font-size: 11px; border: 1px solid #fbbf24; border-radius: 999px; padding: 1px 6px; background: #fef3c7; }
        .reply-box { margin-top: 10px; border-top: 1px solid #e5e7eb; padding-top: 10px; }
        .reply-textarea { width: 100%; border: 1px solid #d1d5db; border-radius: 8px; padding: 8px; box-sizing: border-box; }
        .stderr-window { max-height: 220px; overflow: auto; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px; }
        .diagnostic-window { max-height: 220px; overflow: auto; background: #fff9f2; border: 1px solid #f59e0b; border-radius: 8px; padding: 8px; font-size: 12px; }
        .relation-window { max-height: 220px; overflow: auto; background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 8px; padding: 8px; font-size: 12px; }
        .raw-ref-window { max-height: 180px; overflow: auto; background: #f8fafc; border: 1px solid #d1d5db; border-radius: 8px; padding: 8px; font-size: 12px; }
        .link-btn { border: 0; background: none; color: #0f766e; cursor: pointer; padding: 0; font-size: 12px; text-decoration: underline; }
        @media (max-width: 960px) {
            .row { grid-template-columns: 1fr; }
            .pane-scroll { max-height: 260px; }
            .conversation-window { max-height: 300px; }
            .stderr-window { max-height: 180px; }
        }
    </style>
</head>
<body>
<div class="layout">
    <div class="card">
        <div><a href="/ui/runs">â† Back to Runs</a></div>
        <h2 style="margin:8px 0 4px;">Request: {{ detail.request_id }}</h2>
        <div class="meta">run_id: {{ detail.run_id }}</div>
        <div class="meta">skill: {{ detail.skill_id or "-" }}</div>
        <div class="meta">engine: {{ detail.engine or "-" }}</div>
        <div class="meta">status: <span id="run-status">{{ detail.status }}</span></div>
        <div class="meta">updated_at: <span id="run-updated-at">{{ detail.updated_at or "-" }}</span></div>
        <div class="meta">pending_interaction_id: <span id="run-pending-id">{{ detail.pending_interaction_id if detail.pending_interaction_id is not none else "-" }}</span></div>
        <div class="meta">interaction_count: <span id="run-interaction-count">{{ detail.interaction_count }}</span></div>
    </div>

    <div class="row">
        <div class="card">
            <h3 style="margin:0 0 8px;">Run File Tree (Read-only)</h3>
            <div class="pane-scroll" id="run-file-tree-scroll">
                {% for entry in detail.entries %}
                <div class="tree-line" style="padding-left: {{ entry.depth * 16 }}px;">
                    {% if entry.is_dir %}
                    <span class="dir">ğŸ“ {{ entry.name }}/</span>
                    {% else %}
                    <span class="file">ğŸ“„</span>
                    <a
                        href="#"
                        hx-get="/ui/management/runs/{{ detail.request_id }}/view?path={{ entry.rel_path }}"
                        hx-target="#run-file-preview"
                        hx-swap="innerHTML"
                    >{{ entry.name }}</a>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="card">
            <h3 style="margin:0 0 8px;">File Preview</h3>
            <div class="pane-scroll" id="run-file-preview-scroll">
                <div id="run-file-preview" class="meta">ä»å·¦ä¾§é€‰æ‹©æ–‡ä»¶ã€‚</div>
            </div>
        </div>
    </div>

    <div class="card">
        <h3 style="margin:0 0 8px;">å¯¹è¯åŒºï¼ˆFCMPï¼‰</h3>
        <div id="stdout-log" class="conversation-window"></div>
        <div class="reply-box">
            <div id="pending-state" class="meta">å½“å‰çŠ¶æ€é waiting_userï¼Œè¾“å…¥æ¡†å·²ç¦ç”¨ã€‚</div>
            <div id="pending-prompt" class="meta"></div>
            <form id="pending-reply-form" style="margin-top: 10px;">
                <input id="pending-interaction-id" type="hidden" value="">
                <textarea id="pending-reply-input" class="reply-textarea" rows="3" placeholder="ç­‰å¾…å¾…å†³äº¤äº’..."></textarea>
                <div style="margin-top:8px;">
                    <button id="pending-reply-submit" type="submit">Submit Reply</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <h3 style="margin:0 0 8px;">é”™è¯¯è¾“å‡ºï¼ˆstderrï¼‰</h3>
        <pre id="stderr-log" class="stderr-window"></pre>
        <h3 style="margin:12px 0 8px;">è¯Šæ–­ä¿¡æ¯</h3>
        <div id="diagnostic-log" class="diagnostic-window"></div>
        <h3 style="margin:12px 0 8px;">äº‹ä»¶å…³è”è§†å›¾</h3>
        <div id="relation-view" class="relation-window"></div>
        <h3 style="margin:12px 0 8px;">raw_ref å›è·³é¢„è§ˆ</h3>
        <div id="raw-ref-preview" class="raw-ref-window"></div>
    </div>

    <div class="card">
        <h3 style="margin:0 0 8px;">Run Actions</h3>
        <button id="cancel-run-btn" class="danger" type="button">Cancel Run</button>
    </div>
</div>

<script>
(function () {
    const requestId = {{ detail.request_id | tojson }};
    const statusEl = document.getElementById("run-status");
    const updatedAtEl = document.getElementById("run-updated-at");
    const pendingIdEl = document.getElementById("run-pending-id");
    const interactionCountEl = document.getElementById("run-interaction-count");
    const stdoutEl = document.getElementById("stdout-log");
    const stderrEl = document.getElementById("stderr-log");
    const diagnosticEl = document.getElementById("diagnostic-log");
    const relationEl = document.getElementById("relation-view");
    const rawRefPreviewEl = document.getElementById("raw-ref-preview");
    const pendingStateEl = document.getElementById("pending-state");
    const pendingPromptEl = document.getElementById("pending-prompt");
    const pendingInteractionIdEl = document.getElementById("pending-interaction-id");
    const pendingReplyForm = document.getElementById("pending-reply-form");
    const pendingReplyInput = document.getElementById("pending-reply-input");
    const pendingReplySubmit = document.getElementById("pending-reply-submit");
    const cancelBtn = document.getElementById("cancel-run-btn");

    let cursor = 0;
    let source = null;
    let reconnectTimer = null;
    let terminal = ["succeeded", "failed", "canceled"].includes(statusEl.textContent || "");
    const renderedChatSeq = new Set();

    function setReplyEnabled(enabled, stateText, promptText) {
        pendingReplyInput.disabled = !enabled;
        pendingReplySubmit.disabled = !enabled;
        if (stateText !== undefined) {
            pendingStateEl.textContent = stateText || "";
        }
        if (promptText !== undefined) {
            pendingPromptEl.textContent = promptText || "";
        }
        pendingReplyInput.placeholder = enabled
            ? "è¾“å…¥ç»™ Agent çš„å›å¤å†…å®¹"
            : "ç­‰å¾…å¾…å†³äº¤äº’...";
    }

    function appendLog(target, chunk) {
        if (!chunk) return;
        target.textContent += chunk;
        target.scrollTop = target.scrollHeight;
    }

    function appendDiagnostic(text) {
        if (!text) return;
        const line = document.createElement("div");
        line.textContent = text;
        diagnosticEl.appendChild(line);
        diagnosticEl.scrollTop = diagnosticEl.scrollHeight;
    }

    function renderRelationView() {
        relationEl.textContent = "FCMP å•æµæ¨¡å¼ï¼šrun_event å…³ç³»è§†å›¾å·²åœç”¨ã€‚";
    }

    function lookupConfidence(rawRef) {
        if (!rawRef) return 1.0;
        return 1.0;
    }

    async function previewRawRef(rawRef) {
        if (!rawRef || typeof rawRef.stream !== "string") return;
        const from = Number(rawRef.byte_from || 0);
        const to = Number(rawRef.byte_to || 0);
        rawRefPreviewEl.textContent = `loading ${rawRef.stream}[${from}, ${to}] ...`;
        try {
            const query = new URLSearchParams({
                stream: rawRef.stream,
                byte_from: String(from),
                byte_to: String(to),
            });
            const res = await fetch(`/v1/management/runs/${requestId}/logs/range?${query.toString()}`);
            if (!res.ok) {
                rawRefPreviewEl.textContent = `raw_ref preview unavailable: HTTP ${res.status}`;
                return;
            }
            const payload = await res.json();
            const chunk = payload.chunk || "";
            rawRefPreviewEl.textContent = `${payload.stream}[${payload.byte_from}, ${payload.byte_to}]\n\n${chunk}`;
        } catch (err) {
            rawRefPreviewEl.textContent = `raw_ref preview unavailable: ${String(err)}`;
        }
    }

    function appendChatEvent(type, text, seq, rawRef) {
        if (seq && renderedChatSeq.has(seq)) return;
        if (seq) renderedChatSeq.add(seq);
        const item = document.createElement("div");
        item.className = `chat-item${type === "system" ? " system" : ""}`;
        if (seq) item.setAttribute("data-chat-seq", String(seq));
        const confidence = rawRef ? lookupConfidence(rawRef) : 1.0;
        const title = type === "assistant" ? "Agent" : "System";
        const header = document.createElement("div");
        const strong = document.createElement("strong");
        strong.textContent = title;
        header.appendChild(strong);
        if (confidence < 0.7) {
            const badge = document.createElement("span");
            badge.className = "badge-low-confidence";
            badge.textContent = "low confidence";
            header.appendChild(badge);
        }
        const pre = document.createElement("pre");
        pre.textContent = text || "";
        item.appendChild(header);
        item.appendChild(pre);
        if (rawRef) {
            const meta = document.createElement("div");
            meta.className = "meta";
            const btn = document.createElement("button");
            btn.className = "link-btn";
            btn.type = "button";
            btn.textContent = `raw_ref ${rawRef.stream}[${rawRef.byte_from}, ${rawRef.byte_to}]`;
            btn.addEventListener("click", () => previewRawRef(rawRef));
            meta.appendChild(btn);
            item.appendChild(meta);
        }
        stdoutEl.appendChild(item);
        stdoutEl.scrollTop = stdoutEl.scrollHeight;
    }

    function closeStream() {
        if (source) {
            source.close();
            source = null;
        }
    }

    function updateStatus(payload) {
        if (!payload) return;
        if (payload.status) {
            statusEl.textContent = payload.status;
            terminal = ["succeeded", "failed", "canceled"].includes(payload.status);
            if (terminal) {
                closeStream();
                setReplyEnabled(false, `Run å·²è¿›å…¥ç»ˆæ€ï¼š${payload.status}`, "");
            } else if (payload.status === "running") {
                setReplyEnabled(false, "Run è¿è¡Œä¸­ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡å¾…å†³äº¤äº’ã€‚", "");
            } else if (payload.status === "waiting_user") {
                setReplyEnabled(false, "æ£€æµ‹åˆ° waiting_userï¼Œæ­£åœ¨åŠ è½½å¾…å†³äº¤äº’...", "");
                loadPending().catch(() => {});
            }
        }
        if (payload.updated_at) {
            updatedAtEl.textContent = payload.updated_at;
        }
            if (payload.pending_interaction_id !== undefined) {
            pendingIdEl.textContent = payload.pending_interaction_id === null ? "-" : String(payload.pending_interaction_id);
        }
        if (payload.interaction_count !== undefined && payload.interaction_count !== null) {
            interactionCountEl.textContent = String(payload.interaction_count);
        }
    }

    async function refreshState() {
        const res = await fetch(`/v1/management/runs/${requestId}`);
        if (!res.ok) return;
        const data = await res.json();
        updateStatus(data);
    }

    async function loadPending() {
        const res = await fetch(`/v1/management/runs/${requestId}/pending`);
        if (!res.ok) return;
        const data = await res.json();
        if (!data.pending) {
            pendingInteractionIdEl.value = "";
            setReplyEnabled(false, "å½“å‰æ— å¾…å†³äº¤äº’ã€‚", "");
            return;
        }
        const nextId = Number(data.pending.interaction_id || 0);
        pendingInteractionIdEl.value = nextId > 0 ? String(nextId) : "";
        pendingIdEl.textContent = nextId > 0 ? String(nextId) : "-";
        setReplyEnabled(
            nextId > 0,
            nextId > 0 ? "å¾…å†³äº¤äº’å·²å°±ç»ªï¼Œè¯·è¾“å…¥å›å¤åæäº¤ã€‚" : "å¾…å†³äº¤äº’ä¿¡æ¯æ— æ•ˆã€‚",
            data.pending.prompt || "",
        );
    }

    function scheduleReconnect() {
        if (terminal) return;
        if (reconnectTimer) {
            clearTimeout(reconnectTimer);
        }
        reconnectTimer = setTimeout(() => connectEvents(), 1000);
    }

    function connectEvents() {
        if (terminal) return;
        closeStream();
        const url = `/v1/management/runs/${requestId}/events?cursor=${cursor}`;
        source = new EventSource(url);

        source.addEventListener("snapshot", (evt) => {
            const data = JSON.parse(evt.data || "{}");
            if (typeof data.cursor === "number") {
                cursor = Math.max(cursor, data.cursor);
            }
            updateStatus(data);
        });

        source.addEventListener("chat_event", (evt) => {
            const data = JSON.parse(evt.data || "{}");
            const type = data.type || "";
            const seq = typeof data.seq === "number" ? data.seq : 0;
            if (seq > 0) {
                cursor = Math.max(cursor, seq);
            }
            if (type === "conversation.state.changed") {
                const to = data.data && data.data.to ? data.data.to : "";
                const updatedAt = data.data && data.data.updated_at ? data.data.updated_at : null;
                const pendingId = data.data && data.data.pending_interaction_id !== undefined
                    ? data.data.pending_interaction_id
                    : undefined;
                updateStatus({
                    status: to || undefined,
                    updated_at: updatedAt || undefined,
                    pending_interaction_id: pendingId,
                });
                if (to === "waiting_user") {
                    loadPending().catch(() => {});
                }
                if (to === "running") {
                    setReplyEnabled(false, "Run è¿è¡Œä¸­ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡å¾…å†³äº¤äº’ã€‚", "");
                }
                return;
            }
            if (type === "interaction.reply.accepted") {
                setReplyEnabled(false, "å›å¤å·²æ¥å—ï¼Œæ­£åœ¨æ¢å¤æ‰§è¡Œã€‚", "");
                pendingIdEl.textContent = "-";
                return;
            }
            if (type === "interaction.auto_decide.timeout") {
                appendChatEvent("system", "å·²è§¦å‘è¶…æ—¶è‡ªåŠ¨å†³ç­–å¹¶ç»§ç»­æ‰§è¡Œã€‚", seq, data.raw_ref || null);
                pendingIdEl.textContent = "-";
                return;
            }
            if (type === "assistant.message.final") {
                appendChatEvent("assistant", data.data ? data.data.text : "", seq, data.raw_ref || null);
                return;
            }
            if (type === "user.input.required") {
                const prompt = data.data && data.data.prompt ? data.data.prompt : "Provide next user turn";
                appendChatEvent("system", `ç­‰å¾…ç”¨æˆ·è¾“å…¥: ${prompt}`, seq, data.raw_ref || null);
                pendingPromptEl.textContent = prompt;
                setReplyEnabled(true, "å¾…å†³äº¤äº’å·²å°±ç»ªï¼Œè¯·è¾“å…¥å›å¤åæäº¤ã€‚", prompt);
                return;
            }
            if (type === "conversation.completed") {
                appendChatEvent("system", "ä»»åŠ¡å·²å®Œæˆã€‚", seq, data.raw_ref || null);
                updateStatus({status: "succeeded"});
                return;
            }
            if (type === "conversation.failed") {
                appendChatEvent("system", "ä»»åŠ¡æ‰§è¡Œå¤±è´¥ã€‚", seq, data.raw_ref || null);
                updateStatus({status: "failed"});
                return;
            }
            if (type === "diagnostic.warning") {
                const code = data.data && data.data.code ? data.data.code : "UNKNOWN";
                appendDiagnostic(`[${code}] ${JSON.stringify(data.data || {})}`);
                return;
            }
            if (type === "raw.stderr") {
                appendLog(stderrEl, `${data.data && data.data.line ? data.data.line : ""}\n`);
                return;
            }
            if (type === "raw.stdout") {
                appendDiagnostic(`[raw.stdout] ${data.data && data.data.line ? data.data.line : ""}`);
            }
        });

        source.onerror = () => {
            closeStream();
            if (!terminal && statusEl.textContent !== "waiting_user") {
                scheduleReconnect();
            }
        };
    }

    pendingReplyForm.addEventListener("submit", async (evt) => {
        evt.preventDefault();
        const interactionId = Number(pendingInteractionIdEl.value);
        if (!interactionId) return;
        const payload = {
            interaction_id: interactionId,
            response: {
                text: pendingReplyInput.value || "",
            },
        };
        const res = await fetch(`/v1/management/runs/${requestId}/reply`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(payload),
        });
        if (!res.ok) return;
        pendingReplyInput.value = "";
        pendingInteractionIdEl.value = "";
        setReplyEnabled(false, "å›å¤å·²æäº¤ï¼Œç­‰å¾…åç«¯ç»§ç»­æ‰§è¡Œã€‚", "");
        pendingIdEl.textContent = "-";
        terminal = false;
        await refreshState();
        connectEvents();
    });

    cancelBtn.addEventListener("click", async () => {
        cancelBtn.disabled = true;
        await fetch(`/v1/management/runs/${requestId}/cancel`, {method: "POST"});
        await refreshState();
        closeStream();
    });

    if (statusEl.textContent === "waiting_user") {
        setReplyEnabled(false, "æ£€æµ‹åˆ° waiting_userï¼Œæ­£åœ¨åŠ è½½å¾…å†³äº¤äº’...", "");
        loadPending().catch(() => {});
    } else if (terminal) {
        setReplyEnabled(false, `Run å·²è¿›å…¥ç»ˆæ€ï¼š${statusEl.textContent}`, "");
    } else {
        setReplyEnabled(false, "Run è¿è¡Œä¸­ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡å¾…å†³äº¤äº’ã€‚", "");
        connectEvents();
    }
    renderRelationView();
})();
</script>
</body>
</html>

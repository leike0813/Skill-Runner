<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engine Management</title>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <style>
        body { font-family: "Segoe UI", sans-serif; margin: 0; background: #f7f9fc; color: #1f2937; }
        .layout { max-width: 1180px; margin: 0 auto; padding: 24px; display: grid; gap: 20px; }
        .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 18px; }
        h1 { margin: 0 0 12px; font-size: 24px; }
        h2 { margin: 0 0 10px; font-size: 18px; }
        button { border: 0; border-radius: 8px; background: #0f766e; color: #fff; padding: 8px 12px; cursor: pointer; }
        button:hover { background: #0b5f58; }
        button.secondary { background: #374151; }
        button.secondary:hover { background: #1f2937; }
        button[disabled] { opacity: 0.55; cursor: not-allowed; }
        a { color: #0f766e; text-decoration: none; }
        a:hover { text-decoration: underline; }
        .loading-wrap { display: flex; align-items: center; gap: 10px; color: #374151; }
        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid #d1d5db;
            border-top-color: #0f766e;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .terminal-wrap {
            margin-top: 12px;
            border: 1px solid #1f2937;
            border-radius: 10px;
            overflow: hidden;
            background: #0b1020;
        }
        .terminal-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            background: #111827;
            color: #e5e7eb;
            padding: 10px 12px;
            font-size: 13px;
        }
        .terminal-body { height: 520px; background: #000; }
        #terminal-iframe { width: 100%; height: 100%; border: 0; background: #000; }
        .terminal-actions { display: flex; gap: 8px; align-items: center; }
        .terminal-status-running { color: #86efac; }
        .terminal-status-terminal { color: #fca5a5; }
        .error {
            margin-top: 10px;
            border: 1px solid #fecaca;
            background: #fef2f2;
            color: #991b1b;
            border-radius: 8px;
            padding: 9px 10px;
            font-size: 13px;
            white-space: pre-wrap;
            display: none;
        }
        .warning {
            margin-top: 10px;
            border: 1px solid #fde68a;
            background: #fffbeb;
            color: #92400e;
            border-radius: 8px;
            padding: 9px 10px;
            font-size: 13px;
            white-space: pre-wrap;
            display: none;
        }
        .auth-meta { display: grid; gap: 6px; font-size: 14px; }
        .auth-code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            background: #f3f4f6;
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            display: inline-block;
        }
        .auth-url {
            word-break: break-all;
        }
        .auth-actions { display: flex; gap: 8px; margin-top: 10px; }
        .engine-auth-entry-btn { width: 136px; text-align: center; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
<div class="layout">
    <div class="card">
        <a href="/ui">← Back to UI</a>
        <h1>Engine 管理</h1>
        <div>查看 Engine 状态、触发升级、管理 Model Manifest。</div>
    </div>

    <div class="card">
        <h2>升级全部引擎</h2>
        <form
            hx-post="/ui/engines/upgrades"
            hx-target="#upgrade-status-container"
            hx-swap="innerHTML"
        >
            <input type="hidden" name="mode" value="all">
            <button type="submit">升级全部</button>
        </form>
        <div id="upgrade-status-container" style="margin-top: 12px;"></div>
    </div>

    <div class="card">
        <h2>Engine 状态</h2>
        <div
            id="engines-table-container"
            hx-get="/ui/management/engines/table"
            hx-trigger="load"
            hx-swap="innerHTML"
        >
            <div class="loading-wrap">
                <div class="spinner"></div>
                <div>正在检测 Engine 版本与状态，请稍候...</div>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>Engine Auth（实验）</h2>
        <div style="font-size:13px; color:#6b7280; margin-bottom:10px;">
            鉴权会话与内嵌 TUI 全局互斥。先选择全局鉴权后台，再在引擎表格中点击“连接”入口选择具体方式。
        </div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px;">
            <label for="auth-transport-select" style="font-size:13px; color:#374151;">鉴权后台</label>
            <select id="auth-transport-select" style="padding:8px 10px; border:1px solid #d1d5db; border-radius:8px;">
                <option value="oauth_proxy" selected>OAuth 代理（oauth_proxy）</option>
                <option value="cli_delegate">CLI 委托（cli_delegate）</option>
            </select>
            <button id="auth-cancel-btn" class="secondary" type="button" disabled>取消</button>
        </div>
        <div class="auth-meta">
            <div id="auth-engine-row">引擎：-</div>
            <div id="auth-transport-row">链路：-</div>
            <div id="auth-method-row">鉴权方式：-</div>
            <div id="auth-state">状态：idle</div>
            <div id="auth-url-row" style="display:none;">
                授权地址：
                <a id="auth-url" class="auth-url" href="#" target="_blank" rel="noopener noreferrer"></a>
            </div>
            <div id="auth-code-row" style="display:none;">
                用户代码：
                <span id="auth-code" class="auth-code"></span>
                <button id="auth-code-copy-btn" class="secondary" type="button" style="margin-left:8px; padding:4px 8px;">复制</button>
                <span id="auth-code-copy-result" style="margin-left:8px; font-size:12px; color:#6b7280;"></span>
            </div>
            <div id="auth-expire-row" style="display:none;"></div>
        </div>
        <div id="auth-input-row" style="display:none; margin-top:10px;">
            <label id="auth-input-label" for="auth-input-value" style="display:block; font-size:13px; color:#374151; margin-bottom:6px;">输入</label>
            <input id="auth-input-value" type="text" autocomplete="off" style="width:100%; padding:8px 10px; border:1px solid #d1d5db; border-radius:8px;" />
            <div style="margin-top:8px;">
                <button id="auth-input-btn" type="button">提交</button>
            </div>
        </div>
        <div id="auth-error" class="error"></div>
        <div id="auth-menu-popover" style="display:none; position:fixed; z-index:80; min-width:220px; background:#ffffff; border:1px solid #d1d5db; box-shadow:0 12px 24px rgba(15,23,42,0.16); border-radius:10px; padding:8px;">
            <div id="auth-menu-title" style="font-size:13px; color:#374151; margin-bottom:6px;">请选择</div>
            <div id="auth-menu-items" style="display:grid; gap:6px;"></div>
        </div>
    </div>

    <div class="card">
        <h2>内嵌终端（ttyd）</h2>
        <div style="font-size:13px; color:#6b7280; margin-bottom:10px;">
            通过 ttyd 网关启动引擎 TUI。当前仍采用单会话互斥策略（同一时间仅一个引擎会话）。
        </div>
        {% if not ttyd_available %}
            <div class="error" style="display:block;">
                当前环境未检测到 ttyd。请先安装 ttyd 后再刷新本页。
            </div>
        {% endif %}
        <div class="terminal-wrap">
            <div class="terminal-meta">
                <div id="terminal-state">状态：idle</div>
                <div id="terminal-sandbox">sandbox: unknown</div>
                <div class="terminal-actions">
                    <button id="terminal-reload-btn" class="secondary" type="button">刷新终端</button>
                    <button id="terminal-stop-btn" class="secondary" type="button" disabled>结束终端</button>
                </div>
            </div>
            <div class="terminal-body">
                <iframe id="terminal-iframe" src="about:blank" title="Engine TUI Terminal"></iframe>
            </div>
        </div>
        <div id="terminal-error" class="error"></div>
        <div id="terminal-warning" class="warning"></div>
    </div>
</div>

<script>
(function () {
    const ttydAvailable = {{ "true" if ttyd_available else "false" }};
    const initialSession = {{ session | tojson }};
    const initialAuthSession = {{ auth_session | tojson }};
    const opencodeAuthProviders = {{ opencode_auth_providers | tojson }};
    const authUiCapabilities = {{ auth_ui_capabilities | tojson }};
    const transportLabels = {
        oauth_proxy: "OAuth 代理（oauth_proxy）",
        cli_delegate: "CLI 委托（cli_delegate）",
    };
    const authMethodLabels = {
        callback: "回调模式",
        auth_code_or_url: "授权码模式",
        api_key: "API Key",
    };
    const engineLabels = {
        codex: "Codex",
        gemini: "Gemini",
        iflow: "iFlow",
        opencode: "OpenCode",
    };
    const terminalStatuses = new Set(["succeeded", "failed", "canceled", "expired"]);

    const stateEl = document.getElementById("terminal-state");
    const sandboxEl = document.getElementById("terminal-sandbox");
    const errorEl = document.getElementById("terminal-error");
    const warningEl = document.getElementById("terminal-warning");
    const stopBtn = document.getElementById("terminal-stop-btn");
    const reloadBtn = document.getElementById("terminal-reload-btn");
    const frame = document.getElementById("terminal-iframe");
    const terminalBodyEl = document.querySelector(".terminal-body");
    let currentSession = initialSession || { active: false };
    let currentAuthSession = initialAuthSession || { active: false };
    const authStateEl = document.getElementById("auth-state");
    const authEngineRowEl = document.getElementById("auth-engine-row");
    const authTransportRowEl = document.getElementById("auth-transport-row");
    const authMethodRowEl = document.getElementById("auth-method-row");
    const authUrlRowEl = document.getElementById("auth-url-row");
    const authUrlEl = document.getElementById("auth-url");
    const authCodeRowEl = document.getElementById("auth-code-row");
    const authCodeEl = document.getElementById("auth-code");
    const authCodeCopyBtn = document.getElementById("auth-code-copy-btn");
    const authCodeCopyResultEl = document.getElementById("auth-code-copy-result");
    const authExpireRowEl = document.getElementById("auth-expire-row");
    const authTransportSelectEl = document.getElementById("auth-transport-select");
    const authCancelBtn = document.getElementById("auth-cancel-btn");
    const authInputRowEl = document.getElementById("auth-input-row");
    const authInputLabelEl = document.getElementById("auth-input-label");
    const authInputValueEl = document.getElementById("auth-input-value");
    const authInputBtn = document.getElementById("auth-input-btn");
    const authErrorEl = document.getElementById("auth-error");
    const authMenuPopoverEl = document.getElementById("auth-menu-popover");
    const authMenuTitleEl = document.getElementById("auth-menu-title");
    const authMenuItemsEl = document.getElementById("auth-menu-items");

    let authSubmitLocked = false;
    let authStartPending = false;
    let tuiStartPending = false;
    let authMenuState = null;

    function showError(text) {
        errorEl.style.display = "block";
        errorEl.textContent = text;
    }

    function clearError() {
        errorEl.style.display = "none";
        errorEl.textContent = "";
    }

    function showWarning(text) {
        warningEl.style.display = "block";
        warningEl.textContent = text;
    }

    function clearWarning() {
        warningEl.style.display = "none";
        warningEl.textContent = "";
    }

    function showAuthError(text) {
        authErrorEl.style.display = "block";
        authErrorEl.textContent = text;
    }

    function clearAuthError() {
        authErrorEl.style.display = "none";
        authErrorEl.textContent = "";
    }

    function mapStatusLabel(status) {
        const labels = {
            idle: "空闲",
            running: "运行中",
            starting: "启动中",
            waiting_user: "等待用户操作",
            waiting_orchestrator: "后台编排中",
            code_submitted_waiting_result: "已提交授权码，等待结果",
            polling_result: "轮询结果中",
            succeeded: "成功",
            failed: "失败",
            canceled: "已取消",
            expired: "已过期",
            terminated: "已终止",
            unknown: "未知",
        };
        return labels[status] || status;
    }

    function resolveTransportLabel(transport) {
        const normalized = String(transport || "").trim().toLowerCase();
        return transportLabels[normalized] || normalized || "-";
    }

    function resolveAuthMethodLabel(method) {
        const normalized = String(method || "").trim().toLowerCase();
        return authMethodLabels[normalized] || normalized || "-";
    }

    function resolveInputKind(session) {
        const explicitKind = String(session.input_kind || "").trim().toLowerCase();
        if (explicitKind === "code" || explicitKind === "api_key" || explicitKind === "text") {
            return explicitKind;
        }
        const engine = String(session.engine || "").trim().toLowerCase();
        const authMethod = String(session.auth_method || "").trim().toLowerCase();
        const providerId = String(session.provider_id || "").trim().toLowerCase();
        if (authMethod === "api_key") return "api_key";
        if (authMethod === "callback") return "text";
        if (authMethod === "auth_code_or_url") {
            if (engine === "gemini") return "code";
            if (engine === "iflow") return "text";
            if (engine === "opencode" && providerId === "google") return "text";
            return "";
        }
        return "";
    }

    function resolveInputLabel(session) {
        const engine = String(session.engine || "").trim().toLowerCase();
        const providerId = String(session.provider_id || "").trim().toLowerCase();
        const authMethod = String(session.auth_method || "").trim().toLowerCase();
        if (authMethod === "callback") {
            return "优先等待自动回调；若服务非本地部署，可粘贴登录后的回调 URL 并提交。";
        }
        if (engine === "gemini") {
            return "请将授权码粘贴至下方并提交";
        }
        if (engine === "iflow") {
            return "请将授权码或回调 URL 粘贴至下方并提交";
        }
        const kind = resolveInputKind(session);
        if (kind === "api_key") return "API Key";
        if (kind === "code") return "授权码";
        if (engine === "opencode" && providerId === "google") {
            return "请将登录后浏览器跳转至的 localhost URL 链接整个粘贴至下方并提交";
        }
        if (engine === "opencode" && providerId === "openai") {
            return "请将授权码或回调 URL 粘贴至下方并提交";
        }
        return "输入";
    }

    function isAuthSessionActive(session) {
        const candidate = session || {};
        if (candidate.active === true) return true;
        const status = String(candidate.status || "").trim().toLowerCase();
        if (!status) return false;
        if (candidate.terminal === true) return false;
        return !terminalStatuses.has(status);
    }

    function isTuiSessionActive(session) {
        const candidate = session || {};
        return !!(candidate.active && !candidate.terminal);
    }

    function resolveAuthRoutePrefix(transport) {
        const normalized = String(transport || "").trim().toLowerCase();
        if (normalized === "oauth_proxy") {
            return "/ui/engines/auth/oauth-proxy";
        }
        if (normalized === "cli_delegate") {
            return "/ui/engines/auth/cli-delegate";
        }
        return "/ui/engines/auth";
    }

    function selectedTransport() {
        if (!authTransportSelectEl) return "oauth_proxy";
        return String(authTransportSelectEl.value || "oauth_proxy").trim().toLowerCase();
    }

    function methodsForEngine(transport, engine, providerId) {
        const transportKey = String(transport || "").trim().toLowerCase();
        const engineKey = String(engine || "").trim().toLowerCase();
        const scoped = authUiCapabilities[transportKey] || {};
        const engineCaps = scoped[engineKey];
        if (!engineCaps) return [];
        if (engineKey !== "opencode") {
            return Array.isArray(engineCaps) ? engineCaps : [];
        }
        const providerCaps = (engineCaps && typeof engineCaps === "object") ? engineCaps : {};
        const providerKey = String(providerId || "").trim().toLowerCase();
        const methods = providerCaps[providerKey];
        return Array.isArray(methods) ? methods : [];
    }

    function availableOpencodeProviders(transport) {
        return opencodeAuthProviders.filter((provider) => {
            const providerId = String(provider.provider_id || "").trim().toLowerCase();
            return methodsForEngine(transport, "opencode", providerId).length > 0;
        });
    }

    function hideAuthMenu() {
        authMenuState = null;
        if (authMenuPopoverEl) authMenuPopoverEl.style.display = "none";
        if (authMenuItemsEl) authMenuItemsEl.innerHTML = "";
        if (authMenuTitleEl) authMenuTitleEl.textContent = "请选择";
    }

    function positionAuthMenu(anchor) {
        if (!authMenuPopoverEl || !anchor) return;
        const rect = anchor.getBoundingClientRect();
        authMenuPopoverEl.style.display = "block";
        authMenuPopoverEl.style.left = `${Math.max(12, rect.left)}px`;
        authMenuPopoverEl.style.top = `${Math.min(window.innerHeight - 20, rect.bottom + 6)}px`;
    }

    function renderAuthMenuItems(items, title) {
        if (!authMenuItemsEl || !authMenuTitleEl) return;
        authMenuTitleEl.textContent = title;
        authMenuItemsEl.innerHTML = "";
        items.forEach((item) => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = item.secondary ? "secondary" : "";
            btn.style.textAlign = "left";
            btn.style.width = "100%";
            btn.textContent = item.label;
            btn.addEventListener("click", (evt) => {
                evt.preventDefault();
                evt.stopPropagation();
                item.onClick();
            });
            authMenuItemsEl.appendChild(btn);
        });
    }

    function openEngineAuthMenu(anchor, engine) {
        if (!anchor || isAuthSessionActive(currentAuthSession) || isTuiSessionActive(currentSession)) {
            showAuthError("当前已有进行中的鉴权会话或内嵌终端会话，请先完成或结束后再启动。");
            return;
        }
        clearAuthError();
        const normalizedEngine = String(engine || "").trim().toLowerCase();
        if (!normalizedEngine) return;
        const transport = selectedTransport();
        if (normalizedEngine !== "opencode") {
            const methods = methodsForEngine(transport, normalizedEngine, "");
            if (methods.length === 0) {
                showAuthError("当前鉴权后台下，该引擎暂无可用鉴权方式。");
                return;
            }
            renderAuthMenuItems(
                methods.map((method) => ({
                    label: resolveAuthMethodLabel(method),
                    onClick: () => {
                        hideAuthMenu();
                        startAuth(normalizedEngine, transport, method, "");
                    },
                })),
                `${engineLabels[normalizedEngine] || normalizedEngine} · 选择鉴权方式`
            );
            authMenuState = { level: "method", engine: normalizedEngine, anchor };
            positionAuthMenu(anchor);
            return;
        }

        const providers = availableOpencodeProviders(transport);
        if (providers.length === 0) {
            showAuthError("当前鉴权后台下，OpenCode 没有可用 Provider。");
            return;
        }
        renderAuthMenuItems(
            providers.map((provider) => ({
                label: provider.display_name,
                onClick: () => openOpencodeMethodMenu(anchor, transport, provider),
            })),
            "OpenCode · 选择 Provider"
        );
        authMenuState = { level: "provider", engine: "opencode", anchor };
        positionAuthMenu(anchor);
    }

    function openOpencodeMethodMenu(anchor, transport, provider) {
        const providerId = String(provider.provider_id || "").trim().toLowerCase();
        let methods = methodsForEngine(transport, "opencode", providerId);
        if (methods.length === 0) {
            const authMode = String(provider.auth_mode || "").trim().toLowerCase();
            if (providerId === "openai") {
                methods = ["callback", "auth_code_or_url"];
            } else if (providerId === "google") {
                methods = String(transport || "").toLowerCase() === "oauth_proxy"
                    ? ["callback", "auth_code_or_url"]
                    : ["auth_code_or_url"];
            } else if (authMode === "api_key") {
                methods = String(transport || "").toLowerCase() === "oauth_proxy" ? ["api_key"] : [];
            } else if (authMode === "oauth") {
                methods = String(transport || "").toLowerCase() === "oauth_proxy"
                    ? ["callback", "auth_code_or_url"]
                    : ["auth_code_or_url"];
            }
        }
        if (methods.length === 0) {
            showAuthError(`该 Provider 在当前鉴权后台下没有可用鉴权方式。provider=${providerId}, transport=${transport}`);
            return;
        }
        const items = [
            {
                label: "← 返回 Provider 列表",
                secondary: true,
                onClick: () => openEngineAuthMenu(anchor, "opencode"),
            },
            ...methods.map((method) => ({
                label: resolveAuthMethodLabel(method),
                onClick: () => {
                    hideAuthMenu();
                    startAuth("opencode", transport, method, providerId);
                },
            })),
        ];
        renderAuthMenuItems(items, `OpenCode / ${provider.display_name} · 选择鉴权方式`);
        authMenuState = { level: "method", engine: "opencode", providerId, anchor };
        positionAuthMenu(anchor);
    }

    function shouldShowUserCodeCopy(session) {
        const engine = String(session.engine || "").trim().toLowerCase();
        const providerId = String(session.provider_id || "").trim().toLowerCase();
        const authMethod = String(session.auth_method || "").trim().toLowerCase();
        if (!session.user_code) return false;
        if (authMethod !== "auth_code_or_url") return false;
        return engine === "codex" || (engine === "opencode" && providerId === "openai");
    }

    async function copyText(text) {
        const value = String(text || "");
        if (!value) return false;
        if (navigator.clipboard && typeof navigator.clipboard.writeText === "function") {
            await navigator.clipboard.writeText(value);
            return true;
        }
        const input = document.createElement("textarea");
        input.value = value;
        input.setAttribute("readonly", "readonly");
        input.style.position = "fixed";
        input.style.left = "-99999px";
        document.body.appendChild(input);
        input.focus();
        input.select();
        const copied = document.execCommand("copy");
        document.body.removeChild(input);
        return copied;
    }

    function updateInteractiveActionLocks() {
        const authActive = isAuthSessionActive(currentAuthSession);
        const tuiActive = isTuiSessionActive(currentSession);
        const lockStarts = authActive || tuiActive || authStartPending || tuiStartPending;

        document.querySelectorAll("[data-engine-auth-entry]").forEach((button) => {
            if (button instanceof HTMLButtonElement) {
                button.disabled = lockStarts;
            }
        });
        document.querySelectorAll("[data-engine-start]").forEach((button) => {
            if (button instanceof HTMLButtonElement) {
                button.disabled = lockStarts;
            }
        });

        if (authCancelBtn) authCancelBtn.disabled = !authActive;
        if (authTransportSelectEl) authTransportSelectEl.disabled = lockStarts;
        if (lockStarts) hideAuthMenu();
    }

    function applyAuthState(payload) {
        const next = payload || {};
        const previousSessionId = currentAuthSession.session_id;
        const active = isAuthSessionActive(next);
        currentAuthSession = Object.assign({ active }, next);
        if (previousSessionId !== currentAuthSession.session_id) {
            authSubmitLocked = false;
            if (authInputValueEl) authInputValueEl.value = "";
            if (authCodeCopyResultEl) authCodeCopyResultEl.textContent = "";
        }
        const status = currentAuthSession.status || (active ? "running" : "idle");
        const statusLabel = mapStatusLabel(status);
        const terminalSuffix = currentAuthSession.error ? `: ${currentAuthSession.error}` : "";
        const engine = currentAuthSession.engine || "-";
        const transport = resolveTransportLabel(currentAuthSession.transport || "-");
        const authMethodText = resolveAuthMethodLabel(currentAuthSession.auth_method || "-");
        const authMethodRaw = String(currentAuthSession.auth_method || "-");
        authEngineRowEl.textContent = `引擎：${engine}`;
        authTransportRowEl.textContent = `链路：${transport}`;
        authMethodRowEl.textContent = `鉴权方式：${authMethodText}${authMethodRaw !== "-" ? ` (${authMethodRaw})` : ""}`;
        authStateEl.textContent = `状态：${statusLabel}${terminalSuffix}`;

        const shouldShowAuthUrl = !!currentAuthSession.auth_url && status === "waiting_user" && !authSubmitLocked;
        if (shouldShowAuthUrl) {
            authUrlRowEl.style.display = "block";
            authUrlEl.href = currentAuthSession.auth_url;
            authUrlEl.textContent = currentAuthSession.auth_url;
        } else {
            authUrlRowEl.style.display = "none";
            authUrlEl.removeAttribute("href");
            authUrlEl.textContent = "";
        }

        if (currentAuthSession.user_code) {
            authCodeRowEl.style.display = "block";
            authCodeEl.textContent = currentAuthSession.user_code;
            if (authCodeCopyBtn) {
                authCodeCopyBtn.style.display = shouldShowUserCodeCopy(currentAuthSession) ? "inline-block" : "none";
            }
        } else {
            authCodeRowEl.style.display = "none";
            authCodeEl.textContent = "";
            if (authCodeCopyBtn) authCodeCopyBtn.style.display = "none";
        }

        if (currentAuthSession.expires_at) {
            authExpireRowEl.style.display = "block";
            authExpireRowEl.textContent = `过期时间：${currentAuthSession.expires_at}`;
        } else {
            authExpireRowEl.style.display = "none";
            authExpireRowEl.textContent = "";
        }

        const inputKind = resolveInputKind(currentAuthSession);
        const inputRequired = inputKind === "code" || inputKind === "api_key" || inputKind === "text";
        const showInput =
            !authSubmitLocked
            && inputRequired
            && !currentAuthSession.terminal
            && !terminalStatuses.has(String(status || "").toLowerCase())
            && status === "waiting_user";
        authInputRowEl.style.display = showInput ? "block" : "none";
        authInputBtn.disabled = !showInput;
        authInputLabelEl.textContent = resolveInputLabel(currentAuthSession);
        updateInteractiveActionLocks();
    }

    function buildTtydUrl(port) {
        const protocol = window.location.protocol === "https:" ? "https" : "http";
        const host = window.location.hostname;
        return `${protocol}://${host}:${port}/`;
    }

    function focusTerminalFrame() {
        if (frame.src === "about:blank") return;
        try {
            frame.focus();
            if (frame.contentWindow && typeof frame.contentWindow.focus === "function") {
                frame.contentWindow.focus();
            }
        } catch (_err) {
            frame.focus();
        }
    }

    function applyState(payload) {
        currentSession = payload || { active: false };
        const sandboxStatus = currentSession.sandbox_status || "unknown";
        const sandboxMessage = currentSession.sandbox_message || "";
        sandboxEl.textContent = `sandbox: ${sandboxStatus}`;
        if (sandboxStatus !== "supported" && sandboxMessage) {
            showWarning(sandboxMessage);
        } else {
            clearWarning();
        }

        const running = !!(currentSession.active && !currentSession.terminal);
        stopBtn.disabled = !running;
        stateEl.className = running ? "terminal-status-running" : "terminal-status-terminal";
        if (running) {
            stateEl.textContent = `状态：${currentSession.engine || "-"} running (pid ${currentSession.pid || "-"})`;
            if (currentSession.ttyd_port) {
                const next = buildTtydUrl(currentSession.ttyd_port);
                if (frame.src !== next) {
                    frame.src = next;
                }
                window.setTimeout(focusTerminalFrame, 60);
            }
        } else {
            const status = currentSession.status || "idle";
            const extra = currentSession.error ? `: ${currentSession.error}` : "";
            stateEl.textContent = `状态：${mapStatusLabel(status)}${extra}`;
            frame.src = "about:blank";
        }
        updateInteractiveActionLocks();
    }

    async function fetchSessionState() {
        const res = await fetch("/ui/engines/tui/session");
        if (!res.ok) {
            showError(`读取会话状态失败（HTTP ${res.status}）`);
            return;
        }
        const payload = await res.json();
        applyState(payload);
    }

    async function fetchAuthState() {
        if (currentAuthSession.session_id) {
            const prefix = resolveAuthRoutePrefix(currentAuthSession.transport || "");
            const res = await fetch(`${prefix}/sessions/${encodeURIComponent(currentAuthSession.session_id)}`);
            if (res.ok) {
                const payload = await res.json();
                applyAuthState(payload);
                if (payload.terminal) {
                    clearAuthError();
                }
                return;
            }
            if (res.status !== 404) {
                let detail = `读取鉴权状态失败（HTTP ${res.status}）`;
                try {
                    const payload = await res.json();
                    if (typeof payload.detail === "string") detail = payload.detail;
                } catch (_err) {}
                showAuthError(detail);
                return;
            }
            currentAuthSession = { active: false };
        }
        const activeRes = await fetch("/ui/engines/auth/session/active");
        if (!activeRes.ok) {
            let detail = `读取当前鉴权会话失败（HTTP ${activeRes.status}）`;
            try {
                const payload = await activeRes.json();
                if (typeof payload.detail === "string") detail = payload.detail;
            } catch (_err) {}
            showAuthError(detail);
            return;
        }
        const activePayload = await activeRes.json();
        applyAuthState(activePayload);
        if (!isAuthSessionActive(activePayload)) clearAuthError();
    }

    async function startAuth(engine, transport, authMethod, authProvider) {
        if (isAuthSessionActive(currentAuthSession) || isTuiSessionActive(currentSession)) {
            showAuthError("当前已有进行中的鉴权会话或内嵌终端会话，请先完成或结束后再启动。");
            return;
        }
        clearAuthError();
        authSubmitLocked = false;
        authInputValueEl.value = "";
        const normalizedTransport = (transport || "oauth_proxy");
        const normalizedAuthMethod = String(authMethod || "").trim().toLowerCase();
        if (!normalizedAuthMethod) {
            showAuthError("未选择鉴权方式");
            return;
        }
        const requestBody = {
            engine: engine,
            transport: normalizedTransport,
            auth_method: normalizedAuthMethod,
        };
        if (engine === "opencode") {
            requestBody.provider_id = String(authProvider || "").trim().toLowerCase();
            if (!requestBody.provider_id) {
                showAuthError("请先选择 OpenCode Provider");
                return;
            }
        }
        const prefix = resolveAuthRoutePrefix(normalizedTransport);
        authStartPending = true;
        updateInteractiveActionLocks();
        try {
            const res = await fetch(`${prefix}/sessions`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(requestBody)
            });
            if (!res.ok) {
                let detail = `启动鉴权会话失败（HTTP ${res.status}）`;
                try {
                    const errorPayload = await res.json();
                    if (typeof errorPayload.detail === "string") detail = errorPayload.detail;
                } catch (_err) {}
                showAuthError(detail);
                await fetchAuthState().catch((_err) => {});
                return;
            }
            const responsePayload = await res.json();
            applyAuthState(responsePayload);
        } finally {
            authStartPending = false;
            updateInteractiveActionLocks();
        }
    }

    async function submitAuthInput() {
        if (!currentAuthSession.session_id) return;
        const value = String(authInputValueEl.value || "").trim();
        if (!value) {
            showAuthError("请输入内容");
            return;
        }
        clearAuthError();
        const kind = resolveInputKind(currentAuthSession);
        const prefix = resolveAuthRoutePrefix(currentAuthSession.transport || "");
        const res = await fetch(`${prefix}/sessions/${encodeURIComponent(currentAuthSession.session_id)}/input`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ kind: kind, value: value }),
        });
        if (!res.ok) {
            let detail = `提交输入失败（HTTP ${res.status}）`;
            try {
                const payload = await res.json();
                if (typeof payload.detail === "string") detail = payload.detail;
            } catch (_err) {}
            showAuthError(detail);
            return;
        }
        const payload = await res.json();
        authInputValueEl.value = "";
        authSubmitLocked = true;
        applyAuthState(payload.session || {});
    }

    async function cancelAuth() {
        if (!currentAuthSession.session_id) return;
        clearAuthError();
        const prefix = resolveAuthRoutePrefix(currentAuthSession.transport || "");
        const res = await fetch(`${prefix}/sessions/${encodeURIComponent(currentAuthSession.session_id)}/cancel`, {
            method: "POST"
        });
        if (!res.ok) {
            let detail = `取消鉴权会话失败（HTTP ${res.status}）`;
            try {
                const payload = await res.json();
                if (typeof payload.detail === "string") detail = payload.detail;
            } catch (_err) {}
            showAuthError(detail);
            return;
        }
        const payload = await res.json();
        applyAuthState(payload.session || {});
    }

    async function startTui(engine) {
        if (!ttydAvailable) {
            showError("ttyd 不可用，无法启动内嵌终端。");
            return;
        }
        if (isAuthSessionActive(currentAuthSession) || isTuiSessionActive(currentSession)) {
            showError("当前已有进行中的鉴权会话或内嵌终端会话，请先完成或结束后再启动。");
            return;
        }
        clearError();
        const form = new URLSearchParams();
        form.set("engine", engine);
        tuiStartPending = true;
        updateInteractiveActionLocks();
        try {
            const res = await fetch("/ui/engines/tui/session/start", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: form.toString()
            });
            if (!res.ok) {
                let detail = `启动失败（HTTP ${res.status}）`;
                try {
                    const payload = await res.json();
                    if (typeof payload.detail === "string") detail = payload.detail;
                } catch (_err) {}
                showError(detail);
                await fetchSessionState();
                return;
            }
            const payload = await res.json();
            applyState(payload);
        } finally {
            tuiStartPending = false;
            updateInteractiveActionLocks();
        }
    }

    async function stopTui() {
        clearError();
        const res = await fetch("/ui/engines/tui/session/stop", { method: "POST" });
        if (!res.ok) {
            showError(`停止失败（HTTP ${res.status}）`);
            return;
        }
        const payload = await res.json();
        applyState(payload);
    }

    reloadBtn.addEventListener("click", () => {
        if (frame.src && frame.src !== "about:blank") {
            frame.src = frame.src;
            window.setTimeout(focusTerminalFrame, 60);
        }
    });

    if (stopBtn) {
        stopBtn.addEventListener("click", () => {
            stopTui();
        });
    }
    if (authCancelBtn) {
        authCancelBtn.addEventListener("click", () => {
            cancelAuth();
        });
    }
    if (authInputBtn) {
        authInputBtn.addEventListener("click", () => {
            submitAuthInput();
        });
    }
    if (authCodeCopyBtn) {
        authCodeCopyBtn.addEventListener("click", async () => {
            const code = String((authCodeEl && authCodeEl.textContent) || "").trim();
            if (!code) return;
            if (authCodeCopyResultEl) authCodeCopyResultEl.textContent = "";
            try {
                const ok = await copyText(code);
                if (authCodeCopyResultEl) {
                    authCodeCopyResultEl.textContent = ok ? "已复制" : "复制失败";
                }
            } catch (_err) {
                if (authCodeCopyResultEl) authCodeCopyResultEl.textContent = "复制失败";
            }
        });
    }
    if (authTransportSelectEl) {
        authTransportSelectEl.addEventListener("change", () => {
            hideAuthMenu();
            clearAuthError();
        });
    }

    document.body.addEventListener("click", (evt) => {
        const target = evt.target;
        if (!(target instanceof HTMLElement)) return;
        const startEl = target.closest("[data-engine-start]");
        if (!startEl) return;
        if (startEl instanceof HTMLButtonElement && startEl.disabled) return;
        const engine = startEl.getAttribute("data-engine-start");
        if (!engine) return;
        startTui(engine);
    });
    document.body.addEventListener("click", (evt) => {
        const target = evt.target;
        if (!(target instanceof HTMLElement)) return;
        const authEntryEl = target.closest("[data-engine-auth-entry]");
        if (authEntryEl instanceof HTMLButtonElement && authEntryEl.disabled) return;
        if (authEntryEl) {
            evt.preventDefault();
            evt.stopPropagation();
            const engine = authEntryEl.getAttribute("data-engine-auth-entry");
            if (engine) {
                openEngineAuthMenu(authEntryEl, engine);
            }
            return;
        }
        if (authMenuPopoverEl && authMenuPopoverEl.style.display === "block") {
            const inside = target.closest("#auth-menu-popover");
            if (!inside) {
                hideAuthMenu();
            }
        }
    });
    document.body.addEventListener("htmx:afterSwap", () => {
        updateInteractiveActionLocks();
    });

    frame.addEventListener("load", () => {
        window.setTimeout(focusTerminalFrame, 60);
    });
    if (terminalBodyEl) {
        terminalBodyEl.addEventListener("click", () => {
            window.setTimeout(focusTerminalFrame, 30);
        });
    }

    setInterval(() => {
        fetchSessionState().catch((_err) => {});
        fetchAuthState().catch((_err) => {});
    }, 1500);

    applyState(currentSession);
    applyAuthState(currentAuthSession);
    updateInteractiveActionLocks();
})();
</script>
</body>
</html>

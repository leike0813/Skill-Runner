<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engine Management</title>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <style>
        body { font-family: "Segoe UI", sans-serif; margin: 0; background: #f7f9fc; color: #1f2937; }
        .layout { max-width: 1180px; margin: 0 auto; padding: 24px; display: grid; gap: 20px; }
        .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 18px; }
        h1 { margin: 0 0 12px; font-size: 24px; }
        h2 { margin: 0 0 10px; font-size: 18px; }
        button { border: 0; border-radius: 8px; background: #0f766e; color: #fff; padding: 8px 12px; cursor: pointer; }
        button:hover { background: #0b5f58; }
        button.secondary { background: #374151; }
        button.secondary:hover { background: #1f2937; }
        button[disabled] { opacity: 0.55; cursor: not-allowed; }
        a { color: #0f766e; text-decoration: none; }
        a:hover { text-decoration: underline; }
        .loading-wrap { display: flex; align-items: center; gap: 10px; color: #374151; }
        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid #d1d5db;
            border-top-color: #0f766e;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .terminal-wrap {
            margin-top: 12px;
            border: 1px solid #1f2937;
            border-radius: 10px;
            overflow: hidden;
            background: #0b1020;
        }
        .terminal-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            background: #111827;
            color: #e5e7eb;
            padding: 10px 12px;
            font-size: 13px;
        }
        .terminal-body { height: 520px; background: #000; }
        #terminal-iframe { width: 100%; height: 100%; border: 0; background: #000; }
        .terminal-actions { display: flex; gap: 8px; align-items: center; }
        .terminal-status-running { color: #86efac; }
        .terminal-status-terminal { color: #fca5a5; }
        .error {
            margin-top: 10px;
            border: 1px solid #fecaca;
            background: #fef2f2;
            color: #991b1b;
            border-radius: 8px;
            padding: 9px 10px;
            font-size: 13px;
            white-space: pre-wrap;
            display: none;
        }
        .warning {
            margin-top: 10px;
            border: 1px solid #fde68a;
            background: #fffbeb;
            color: #92400e;
            border-radius: 8px;
            padding: 9px 10px;
            font-size: 13px;
            white-space: pre-wrap;
            display: none;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
<div class="layout">
    <div class="card">
        <a href="/ui">← Back to UI</a>
        <h1>Engine 管理</h1>
        <div>查看 Engine 状态、触发升级、管理 Model Manifest。</div>
    </div>

    <div class="card">
        <h2>升级全部引擎</h2>
        <form
            hx-post="/ui/engines/upgrades"
            hx-target="#upgrade-status-container"
            hx-swap="innerHTML"
        >
            <input type="hidden" name="mode" value="all">
            <button type="submit">升级全部</button>
        </form>
        <div id="upgrade-status-container" style="margin-top: 12px;"></div>
    </div>

    <div class="card">
        <h2>Engine 状态</h2>
        <div
            id="engines-table-container"
            hx-get="/ui/management/engines/table"
            hx-trigger="load"
            hx-swap="innerHTML"
        >
            <div class="loading-wrap">
                <div class="spinner"></div>
                <div>正在检测 Engine 版本与状态，请稍候...</div>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>内嵌终端（ttyd）</h2>
        <div style="font-size:13px; color:#6b7280; margin-bottom:10px;">
            通过 ttyd 网关启动引擎 TUI。当前仍采用单会话互斥策略（同一时间仅一个引擎会话）。
        </div>
        {% if not ttyd_available %}
            <div class="error" style="display:block;">
                当前环境未检测到 ttyd。请先安装 ttyd 后再刷新本页。
            </div>
        {% endif %}
        <div class="terminal-wrap">
            <div class="terminal-meta">
                <div id="terminal-state">状态：idle</div>
                <div id="terminal-sandbox">sandbox: unknown</div>
                <div class="terminal-actions">
                    <button id="terminal-reload-btn" class="secondary" type="button">刷新终端</button>
                    <button id="terminal-stop-btn" class="secondary" type="button" disabled>结束终端</button>
                </div>
            </div>
            <div class="terminal-body">
                <iframe id="terminal-iframe" src="about:blank" title="Engine TUI Terminal"></iframe>
            </div>
        </div>
        <div id="terminal-error" class="error"></div>
        <div id="terminal-warning" class="warning"></div>
    </div>
</div>

<script>
(function () {
    const ttydAvailable = {{ "true" if ttyd_available else "false" }};
    const initialSession = {{ session | tojson }};
    const stateEl = document.getElementById("terminal-state");
    const sandboxEl = document.getElementById("terminal-sandbox");
    const errorEl = document.getElementById("terminal-error");
    const warningEl = document.getElementById("terminal-warning");
    const stopBtn = document.getElementById("terminal-stop-btn");
    const reloadBtn = document.getElementById("terminal-reload-btn");
    const frame = document.getElementById("terminal-iframe");
    const terminalBodyEl = document.querySelector(".terminal-body");
    let currentSession = initialSession || { active: false };

    function showError(text) {
        errorEl.style.display = "block";
        errorEl.textContent = text;
    }

    function clearError() {
        errorEl.style.display = "none";
        errorEl.textContent = "";
    }

    function showWarning(text) {
        warningEl.style.display = "block";
        warningEl.textContent = text;
    }

    function clearWarning() {
        warningEl.style.display = "none";
        warningEl.textContent = "";
    }

    function buildTtydUrl(port) {
        const protocol = window.location.protocol === "https:" ? "https" : "http";
        const host = window.location.hostname;
        return `${protocol}://${host}:${port}/`;
    }

    function focusTerminalFrame() {
        if (frame.src === "about:blank") return;
        try {
            frame.focus();
            if (frame.contentWindow && typeof frame.contentWindow.focus === "function") {
                frame.contentWindow.focus();
            }
        } catch (_err) {
            frame.focus();
        }
    }

    function applyState(payload) {
        currentSession = payload || { active: false };
        const sandboxStatus = currentSession.sandbox_status || "unknown";
        const sandboxMessage = currentSession.sandbox_message || "";
        sandboxEl.textContent = `sandbox: ${sandboxStatus}`;
        if (sandboxStatus !== "supported" && sandboxMessage) {
            showWarning(sandboxMessage);
        } else {
            clearWarning();
        }

        const running = !!(currentSession.active && !currentSession.terminal);
        stopBtn.disabled = !running;
        stateEl.className = running ? "terminal-status-running" : "terminal-status-terminal";
        if (running) {
            stateEl.textContent = `状态：${currentSession.engine || "-"} running (pid ${currentSession.pid || "-"})`;
            if (currentSession.ttyd_port) {
                const next = buildTtydUrl(currentSession.ttyd_port);
                if (frame.src !== next) {
                    frame.src = next;
                }
                window.setTimeout(focusTerminalFrame, 60);
            }
        } else {
            const status = currentSession.status || "idle";
            const extra = currentSession.error ? `: ${currentSession.error}` : "";
            stateEl.textContent = `状态：${status}${extra}`;
            frame.src = "about:blank";
        }
    }

    async function fetchSessionState() {
        const res = await fetch("/ui/engines/tui/session");
        if (!res.ok) {
            showError(`读取会话状态失败（HTTP ${res.status}）`);
            return;
        }
        const payload = await res.json();
        applyState(payload);
    }

    async function startTui(engine) {
        if (!ttydAvailable) {
            showError("ttyd 不可用，无法启动内嵌终端。");
            return;
        }
        clearError();
        const form = new URLSearchParams();
        form.set("engine", engine);
        const res = await fetch("/ui/engines/tui/session/start", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: form.toString()
        });
        if (!res.ok) {
            let detail = `启动失败（HTTP ${res.status}）`;
            try {
                const payload = await res.json();
                if (typeof payload.detail === "string") detail = payload.detail;
            } catch (_err) {}
            showError(detail);
            await fetchSessionState();
            return;
        }
        const payload = await res.json();
        applyState(payload);
    }

    async function stopTui() {
        clearError();
        const res = await fetch("/ui/engines/tui/session/stop", { method: "POST" });
        if (!res.ok) {
            showError(`停止失败（HTTP ${res.status}）`);
            return;
        }
        const payload = await res.json();
        applyState(payload);
    }

    reloadBtn.addEventListener("click", () => {
        if (frame.src && frame.src !== "about:blank") {
            frame.src = frame.src;
            window.setTimeout(focusTerminalFrame, 60);
        }
    });

    stopBtn.addEventListener("click", () => {
        stopTui();
    });

    document.body.addEventListener("click", (evt) => {
        const target = evt.target;
        if (!(target instanceof HTMLElement)) return;
        const engine = target.getAttribute("data-engine-start");
        if (!engine) return;
        startTui(engine);
    });

    frame.addEventListener("load", () => {
        window.setTimeout(focusTerminalFrame, 60);
    });
    if (terminalBodyEl) {
        terminalBodyEl.addEventListener("click", () => {
            window.setTimeout(focusTerminalFrame, 30);
        });
    }

    setInterval(() => {
        fetchSessionState().catch((_err) => {});
    }, 1500);

    applyState(currentSession);
})();
</script>
</body>
</html>

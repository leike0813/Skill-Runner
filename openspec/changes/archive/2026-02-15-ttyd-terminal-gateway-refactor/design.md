## Context

当前实现通过应用内 PTY 管线自行处理：
- 子进程启动与生命周期
- stdout/stderr 流转发
- 终端控制序列渲染适配
- 复制/选择/滚动等交互细节

该链路在多引擎 TUI 场景下长期不稳定。  
本次重构目标是将“终端交互协议与渲染细节”下沉给 ttyd，服务仅保留会话编排与安全边界控制。

## Goals

1. 以 ttyd 作为内嵌终端网关，提升渲染与交互稳定性。
2. 保持现有产品约束：单会话全局互斥。
3. 保持现有安全边界：白名单命令、受控工作目录、受控环境变量。
4. 与本地/容器部署保持一致行为。

## Non-Goals

1. 不引入多会话并发。
2. 不开放任意命令执行。
3. 不在本次扩展额外终端页面；继续在 `/ui/engines` 内使用。

## Architecture

### 1) 会话模型

- `ui_shell_manager` 维护唯一活跃会话状态：
  - `session_id`
  - `engine`
  - `ttyd_pid`
  - `ttyd_listen_host/port`（监听 `127.0.0.1`）
  - `started_at`
  - `status`（running/stopped/error）
- 新启动请求在已有活跃会话时返回 busy（HTTP 409）。

### 2) 启动流程

1. 校验 `engine` 属于白名单（codex/gemini/iflow）。
2. 创建会话目录：`data/ui_shell_sessions/<session_id>`。
3. 组装引擎默认 TUI 命令（固定命令映射）。
4. 启动 ttyd 进程，命令形态：
   - `ttyd` + 受控参数 + `--` + 引擎命令
5. 返回会话信息（含可嵌入访问路径）。

### 3) 终端展示

- UI 引擎页中的终端区域改为嵌入 ttyd 终端视图（iframe 或等价同源代理入口）。
- “结束终端”按钮调用 stop 接口，后端终止 ttyd 及其子进程树。

### 4) 终止与清理

- Stop 时必须：
  1. 结束 ttyd 进程组。
  2. 将会话状态置为 stopped。
  3. 释放全局会话锁。
- 若 ttyd 异常退出，状态轮询应反映 error/stopped，避免 UI 假死。

### 5) 安全边界

1. 仅允许固定引擎命令映射。
2. ttyd 监听地址与端口通过环境变量受控（`UI_SHELL_TTYD_BIND_HOST` / `UI_SHELL_TTYD_PORT`）。
3. 保留 managed 环境变量注入（agent_home/cache/path 等）。
4. 继续沿用当前 sandbox 探测与标注策略（不在本次新增阻断策略）。

## Dependency Strategy

1. 新增 `ttyd` 运行时依赖（本地与容器）。
2. 文档明确：
   - 本地部署需安装 ttyd（或由一键脚本自动安装）。
   - 容器镜像内预装 ttyd。

## Risks & Mitigations

1. **风险：ttyd 在不同发行版安装方式差异**
   - 缓解：部署脚本按平台探测安装命令；缺失时给出明确错误提示。
2. **风险：端口占用/代理路径冲突**
   - 缓解：启动时动态分配回环端口，失败即重试有限次数并报错。
3. **风险：会话残留导致后续 409**
   - 缓解：状态检查时检测 ttyd PID 存活性，自动回收僵尸会话。

## Test Strategy

1. 服务层：
   - 正常启动/停止 ttyd 会话。
   - 并发启动返回 409（单会话互斥）。
   - ttyd 缺失时返回明确可诊断错误。
2. 路由层：
   - 引擎页可拿到会话状态与嵌入入口。
   - stop 后可再次启动其他引擎。
3. UI 回归：
   - 终端显示、滚动、复制行为以 ttyd 默认能力为准（不再依赖自研桥接逻辑）。

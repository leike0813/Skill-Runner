## Context

现有内建 UI 主要服务管理场景，虽然可观测 run 过程，但不覆盖“从技能发现、输入组装、上传、提交、交互回复到结果渲染”的完整客户端执行链路。E2E 测试需要一个更接近真实客户端行为的内建实现，同时要求与主服务解耦（独立端口），避免与现有 `/ui` 管理页职责混杂。

约束：
- 示例客户端必须独立服务化，具备独立 app 入口与端口配置（默认 `8011`，支持环境变量覆盖并回退）。
- 技术栈与内建 UI 保持一致（Jinja2 + htmx + 原生 JS）。
- 尽量复用现有 management/jobs API，减少重复协议。
- 客户端需要基于 Skill 规格动态渲染输入表单，因此后端需提供可直接消费的 schema 内容。
- 客户端实现代码需独立目录，不放在 `server/` 下。

## Goals / Non-Goals

**Goals:**
- 提供独立端口运行的内建示例客户端，用于 E2E 测试与演示。
- 完成端到端用户流：
  - 读取 Skill 列表与详情
  - 动态输入（inline input + parameter）与文件上传
  - 执行提交与运行期观测
  - waiting_user 场景下 pending/reply 交互
  - 终态结果与产物展示
- 将客户端动态表单构建所需的 schema 能力纳入 management API。

**Non-Goals:**
- 不替代现有 `/ui` 管理页，也不迁移管理页功能到示例客户端。
- 不引入新的前端框架（如 React/Vue）。
- 不在本 change 内实现复杂的可视化编辑器或多用户鉴权体系。

## Decisions

### 1) 采用独立 FastAPI app 入口
- 决策：新增独立目录 `e2e_client/`，包含 `app.py` 与独立路由/模板；服务独立端口启动。
- 原因：满足“独立服务/独立端口”要求，并隔离主服务职责。
- 备选：在主 app 挂载子路由并共享端口。  
  不选原因：与“独立端口”要求冲突，且测试隔离性差。

### 1.1) 端口配置策略固定为“默认 + 环境变量覆盖”
- 决策：默认端口使用 `8011`；支持 `SKILL_RUNNER_E2E_CLIENT_PORT` 覆盖，缺失或无效时回退 `8011`。
- 原因：满足默认可用与部署可配置的双要求，避免引入交互式配置步骤。

### 2) 客户端仅通过 HTTP 调后端，不直接读本地 Skill 文件
- 决策：示例客户端从后端 API 获取 Skill 列表、描述、schema，避免本地路径耦合。
- 原因：更贴近真实客户端行为，具备跨部署一致性。
- 备选：客户端直接访问 `skills/` 目录。  
  不选原因：破坏“客户端-服务端”边界，无法模拟真实远端接入。

### 3) 在 management API 增加 schema 获取端点
- 决策：新增 Skill schema 读取能力（例如 `GET /v1/management/skills/{skill_id}/schemas`）。
- 原因：动态表单和前置校验需要 schema 内容，现有接口以元数据/路径为主，信息不足。
- 备选：复用 `/v1/skills/{skill_id}` 的路径信息自行拼接读取。  
  不选原因：客户端无法安全稳定获取 schema 文件实体。

### 4) 示例客户端交互流程复用现有 run 协议
- 决策：执行与交互使用现有端点：
  - 创建与上传：`/v1/jobs` + `/v1/jobs/{request_id}/upload`
  - 观测：`/v1/management/runs/{request_id}` + `/events`
  - 交互：`/pending` + `/reply`
  - 结果：`/v1/jobs/{request_id}/result` + 产物接口
- 原因：减少新协议引入，提升一致性与可维护性。

### 5) 强制低耦合边界：仅 HTTP 协议复用
- 决策：示例客户端不直接 import `server` 内部业务服务，仅通过公开 HTTP API 交互。
- 原因：保持“独立客户端”语义，减少内部结构变更对客户端的影响。
- 备选：直接复用 `server` 内部 service 层。  
  不选原因：内部耦合高，破坏独立部署与测试模拟目标。

### 6) 录制回放作为本 change 必做 MVP
- 决策：实现最小录制回放能力，覆盖“创建运行/上传/pending/reply/结果读取”关键请求与响应。
- 原因：用户明确要求“最好实现”，并已确认作为本 change 必做项。
- MVP 范围：
  - 录制：按一次会话写入结构化记录文件（时间戳、请求摘要、响应摘要、关键状态）。
  - 回放：读取记录并在客户端视图重放步骤与关键结果，不要求完全重发到后端。

### 6.1) 回放交互模式采用“单步播放”
- 决策：回放视图在本 change 仅提供单步播放，不提供自动播放。
- 原因：用户已确认选择方案 `1`，且单步模式更利于 E2E 调试定位，复杂度也更可控。
- 影响：自动播放作为后续可选增强项，不影响当前 MVP 验收。

### 7) 同步产出 UI 设计参考文档
- 决策：新增 `docs/e2e_example_client_ui_reference.md`，沉淀信息架构、页面结构、交互状态与关键组件规范。
- 原因：支撑后续迭代与测试对齐，避免 UI 行为漂移。

### 8) 增加“可重复进入 run 实时观测”的统一入口
- 决策：在示例客户端增加独立 Runs 列表页，按客户端已创建会话（recording）聚合展示，并提供“Open Observation”入口直达 `/runs/{request_id}`。
- 原因：解决用户关闭观测页后无法从 UI 重新进入实时观测的问题。
- 说明：
  - run 的“再次进入”入口以 Runs 列表页为主；
  - Replay 作为观测页的子功能保留，不再承担唯一入口职责。

### 9) 结果页文件树/预览复用管理 UI run 观测交互模式
- 决策：结果页的 bundle 文件树和预览区域采用与内建管理 UI `run_detail` 相同的信息结构与交互方式（左侧树、右侧预览、滚动容器、点击文件加载预览片段）。
- 原因：降低认知切换成本，避免两套相似功能出现交互不一致。
- 实现策略：
  - 复用同构 DOM 结构与样式类（`pane-scroll`、树节点层级样式）；
  - 增加 e2e 客户端文件预览局部渲染端点，供 `hx-get` 载入预览片段。

## Risks / Trade-offs

- [风险] 新增独立服务导致启动与配置复杂度上升  
  → 缓解：提供最小启动脚本与默认端口约定，文档明确如何与主服务联调。

- [风险] schema 端点返回体设计不稳定，影响客户端动态渲染  
  → 缓解：定义固定响应模型（input/parameter/output 三段）并加入集成测试。

- [风险] 示例客户端与主服务版本不一致导致 E2E 波动  
  → 缓解：同仓版本联动发布；测试中显式校验后端能力与错误提示。

- [风险] 交互流程（waiting_user）状态收敛复杂  
  → 缓解：沿用现有 management run 语义，不新增状态机分支，仅做前端适配。

## Migration Plan

1. 增加 management schema 获取端点与响应模型。
2. 新建 `e2e_client/` 独立服务目录，完成端口配置（默认 8011 + 环境变量覆盖回退）。
3. 实现执行页（动态输入/上传/提交）与运行页（SSE+pending/reply）逻辑。
4. 实现结果页（result + artifacts）展示。
5. 实现录制回放 MVP（记录关键请求/响应并支持回放）。
6. 产出 UI 设计参考文档并补充集成测试与 E2E 路径文档。
7. 增加 Runs 列表页，并提供每个 request_id 的实时观测重入入口。
8. 将结果页 bundle 文件树/预览改造成管理 UI run 观测同构交互模式。

回滚策略：
- 若出现问题，可停止独立示例客户端服务并回滚新增 app/router/template，不影响主服务执行链路。

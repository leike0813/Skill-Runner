{% extends "base.html" %}
{% block content %}
<section class="card">
    <h2 style="margin-top: 0;">Run Skill: {{ skill.name or skill.id }}</h2>
    <p class="muted"><code>{{ skill.id }}</code> • engines: {{ ", ".join(engines) }}</p>
    <p class="muted"><strong>Run Source:</strong> {{ run_source }}</p>

    {% for error in errors %}
        <div class="error">{{ error }}</div>
    {% endfor %}

    <form method="post" enctype="multipart/form-data" action="{{ form_action }}">
        <div style="margin-bottom: 14px;">
            <label for="engine"><strong>Engine</strong></label><br>
            <select id="engine" name="engine" style="padding:8px; border-radius:8px; border:1px solid #c9ddce;">
                {% for engine in engines %}
                    <option value="{{ engine }}" {% if selected_engine == engine %}selected{% endif %}>{{ engine }}</option>
                {% endfor %}
            </select>
        </div>
        <div style="margin-bottom: 14px;">
            <label for="execution_mode"><strong>Execution Mode</strong></label><br>
            <select id="execution_mode" name="execution_mode" style="padding:8px; border-radius:8px; border:1px solid #c9ddce;">
                {% for mode in execution_modes %}
                    <option value="{{ mode }}" {% if selected_execution_mode == mode %}selected{% endif %}>{{ mode }}</option>
                {% endfor %}
            </select>
            <div class="muted">Loaded from backend skill detail.</div>
        </div>
        <div style="margin-bottom: 14px;">
            <label for="provider"><strong>Provider</strong></label><br>
            <select id="provider" name="provider" style="padding:8px; border-radius:8px; border:1px solid #c9ddce; min-width: 200px;">
            </select>
            <div class="muted">For non-opencode engines this is a fixed display value.</div>
        </div>
        <div style="margin-bottom: 14px;">
            <label for="model_value"><strong>Model</strong></label><br>
            <select id="model_value" name="model_value" style="padding:8px; border-radius:8px; border:1px solid #c9ddce; min-width: 280px;">
                <option value="">(Backend default)</option>
            </select>
            <input type="hidden" id="model" name="model" value="{{ selected_model }}">
            <div class="muted">Models are loaded from management engine detail for selected engine.</div>
        </div>

        <div class="row">
            <div class="card" style="flex: 1 1 320px;">
                <h3 style="margin-top: 0;">Inline Input</h3>
                {% if inline_fields %}
                    {% for field in inline_fields %}
                        <div style="margin-bottom: 12px;">
                            <label for="input__{{ field.name }}"><strong>{{ field.name }}</strong>{% if field.required %} *{% endif %}</label><br>
                            <input id="input__{{ field.name }}" name="input__{{ field.name }}" value="{{ submitted_input.get(field.name, '') }}"
                                   style="width:100%; padding:8px; border-radius:8px; border:1px solid #c9ddce;">
                            <div class="muted">{{ field.type }}{% if field.description %} • {{ field.description }}{% endif %}</div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="muted">No inline input field.</div>
                {% endif %}
            </div>

            <div class="card" style="flex: 1 1 320px;">
                <h3 style="margin-top: 0;">Parameters</h3>
                {% if parameter_fields %}
                    {% for field in parameter_fields %}
                        <div style="margin-bottom: 12px;">
                            <label for="parameter__{{ field.name }}"><strong>{{ field.name }}</strong>{% if field.required %} *{% endif %}</label><br>
                            <input id="parameter__{{ field.name }}" name="parameter__{{ field.name }}" value="{{ submitted_parameter.get(field.name, '') }}"
                                   style="width:100%; padding:8px; border-radius:8px; border:1px solid #c9ddce;">
                            <div class="muted">{{ field.type }}{% if field.description %} • {{ field.description }}{% endif %}</div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="muted">No parameter field.</div>
                {% endif %}
            </div>
        </div>

        <div class="card" style="margin-top: 16px;">
            <h3 style="margin-top: 0;">File Upload</h3>
            {% if run_source == "temp" %}
                <p class="muted">The selected fixture skill is dynamically packaged and uploaded via <code>/v1/temp-skill-runs/{request_id}/upload</code>. Input files are zipped with schema keys as entry names.</p>
            {% else %}
                <p class="muted">Each selected file is zipped with its field name as file name before calling <code>/v1/jobs/{request_id}/upload</code>.</p>
            {% endif %}
            {% if file_fields %}
                {% for field in file_fields %}
                    <div style="margin-bottom: 12px;">
                        <label for="file__{{ field.name }}"><strong>{{ field.name }}</strong>{% if field.required %} *{% endif %}</label><br>
                        <input id="file__{{ field.name }}" name="file__{{ field.name }}" type="file">
                        <div class="muted">{{ field.type }}{% if field.description %} • {{ field.description }}{% endif %}</div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="muted">No file input field.</div>
            {% endif %}
        </div>

        <div class="card" style="margin-top: 16px;">
            <h3 style="margin-top: 0;">Runtime Options</h3>
            <div class="row">
                <div style="flex: 1 1 260px;">
                    <label><input type="checkbox" name="runtime__verbose" {% if submitted_runtime_options.get("verbose") %}checked{% endif %}> verbose</label><br>
                    <label><input type="checkbox" name="runtime__no_cache" {% if submitted_runtime_options.get("no_cache") %}checked{% endif %}> no_cache</label><br>
                    <label><input type="checkbox" name="runtime__debug" {% if submitted_runtime_options.get("debug") %}checked{% endif %}> debug</label><br>
                    <label><input type="checkbox" name="runtime__debug_keep_temp" {% if submitted_runtime_options.get("debug_keep_temp") %}checked{% endif %}> debug_keep_temp</label>
                </div>
                <div style="flex: 1 1 280px;">
                    <label for="runtime__interactive_require_user_reply"><strong>interactive_require_user_reply</strong></label><br>
                    <select id="runtime__interactive_require_user_reply" name="runtime__interactive_require_user_reply" style="padding:8px; border-radius:8px; border:1px solid #c9ddce;">
                        <option value="" {% if not submitted_runtime_options.get("interactive_require_user_reply") %}selected{% endif %}>(Default)</option>
                        <option value="true" {% if submitted_runtime_options.get("interactive_require_user_reply") == "true" %}selected{% endif %}>true</option>
                        <option value="false" {% if submitted_runtime_options.get("interactive_require_user_reply") == "false" %}selected{% endif %}>false</option>
                    </select>
                </div>
            </div>
            <div class="row" style="margin-top: 12px;">
                <div style="flex: 1 1 240px;">
                    <label for="runtime__session_timeout_sec"><strong>session_timeout_sec</strong></label><br>
                    <input id="runtime__session_timeout_sec" name="runtime__session_timeout_sec" value="{{ submitted_runtime_options.get('session_timeout_sec', '') }}"
                           style="width:100%; padding:8px; border-radius:8px; border:1px solid #c9ddce;">
                </div>
                <div style="flex: 1 1 240px;">
                    <label for="runtime__interactive_wait_timeout_sec"><strong>interactive_wait_timeout_sec</strong></label><br>
                    <input id="runtime__interactive_wait_timeout_sec" name="runtime__interactive_wait_timeout_sec" value="{{ submitted_runtime_options.get('interactive_wait_timeout_sec', '') }}"
                           style="width:100%; padding:8px; border-radius:8px; border:1px solid #c9ddce;">
                </div>
                <div style="flex: 1 1 240px;">
                    <label for="runtime__hard_wait_timeout_sec"><strong>hard_wait_timeout_sec</strong></label><br>
                    <input id="runtime__hard_wait_timeout_sec" name="runtime__hard_wait_timeout_sec" value="{{ submitted_runtime_options.get('hard_wait_timeout_sec', '') }}"
                           style="width:100%; padding:8px; border-radius:8px; border:1px solid #c9ddce;">
                </div>
                <div style="flex: 1 1 240px;">
                    <label for="runtime__wait_timeout_sec"><strong>wait_timeout_sec</strong></label><br>
                    <input id="runtime__wait_timeout_sec" name="runtime__wait_timeout_sec" value="{{ submitted_runtime_options.get('wait_timeout_sec', '') }}"
                           style="width:100%; padding:8px; border-radius:8px; border:1px solid #c9ddce;">
                </div>
            </div>
        </div>

        <div style="margin-top: 16px;">
            <button type="submit" class="btn">Create Run</button>
            <a class="btn secondary" href="/">Back</a>
        </div>
    </form>
</section>
<script>
(() => {
    const engineModels = {{ engine_models_by_engine | tojson }};
    const selectedProvider = {{ selected_provider | tojson }};
    const selectedModel = {{ selected_model | tojson }};
    const fixedProviders = {
        codex: "openai",
        gemini: "google",
        iflow: "iflowcn",
    };
    const engineSelect = document.getElementById("engine");
    const providerSelect = document.getElementById("provider");
    const modelSelect = document.getElementById("model_value");
    const modelHidden = document.getElementById("model");

    function splitProviderModel(id) {
        if (typeof id !== "string") return null;
        const idx = id.indexOf("/");
        if (idx <= 0 || idx >= id.length - 1) return null;
        return { provider: id.slice(0, idx), model: id.slice(idx + 1) };
    }

    function providerFromRow(row) {
        if (row && typeof row.provider === "string" && row.provider.trim()) {
            return row.provider.trim();
        }
        const parsed = splitProviderModel(row && typeof row.id === "string" ? row.id.trim() : "");
        return parsed ? parsed.provider : "";
    }

    function modelNameFromRow(row) {
        if (row && typeof row.model === "string" && row.model.trim()) {
            return row.model.trim();
        }
        const parsed = splitProviderModel(row && typeof row.id === "string" ? row.id.trim() : "");
        return parsed ? parsed.model : "";
    }

    function normalizeRows(engine) {
        const rows = Array.isArray(engineModels[engine]) ? engineModels[engine] : [];
        return rows.filter((row) => row && typeof row.id === "string");
    }

    function renderProviders() {
        const engine = engineSelect.value;
        const rows = normalizeRows(engine);
        let providers = [];
        if (engine === "opencode") {
            const seen = new Set();
            for (const row of rows) {
                const provider = providerFromRow(row);
                if (!provider || seen.has(provider)) continue;
                seen.add(provider);
                providers.push(provider);
            }
            providers = providers.sort();
            if (!providers.length && selectedProvider) {
                providers.push(selectedProvider);
            }
        } else {
            const fallbackProvider = fixedProviders[engine] || engine;
            if (fallbackProvider) {
                providers = [fallbackProvider];
            }
        }
        providerSelect.innerHTML = "";
        if (!providers.length) {
            const option = document.createElement("option");
            option.value = "";
            option.textContent = "(N/A)";
            providerSelect.appendChild(option);
            return;
        }
        for (const provider of providers) {
            const option = document.createElement("option");
            option.value = provider;
            option.textContent = provider;
            providerSelect.appendChild(option);
        }
        const desired = providerSelect.value || selectedProvider || providers[0];
        if ([...providerSelect.options].some((item) => item.value === desired)) {
            providerSelect.value = desired;
        } else {
            providerSelect.value = providers[0];
        }
    }

    function renderModels() {
        const engine = engineSelect.value;
        const rows = normalizeRows(engine);
        const selectedProviderValue = providerSelect.value || "";
        const current = modelHidden.value || selectedModel || "";
        modelSelect.innerHTML = "";
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "(Backend default)";
        modelSelect.appendChild(defaultOption);
        for (const row of rows) {
            const rowProvider = providerFromRow(row);
            const rowModel = modelNameFromRow(row);
            if (engine === "opencode" && selectedProviderValue && rowProvider !== selectedProviderValue) {
                continue;
            }
            let modelId = typeof row.id === "string" ? row.id.trim() : "";
            if (!modelId && rowProvider && rowModel) {
                modelId = `${rowProvider}/${rowModel}`;
            }
            if (!modelId) continue;
            const option = document.createElement("option");
            option.value = modelId;
            if (engine === "opencode") {
                option.textContent = row.display_name ? `${row.display_name} (${rowModel || modelId})` : (rowModel || modelId);
            } else {
                option.textContent = row.display_name ? `${row.display_name} (${modelId})` : modelId;
            }
            modelSelect.appendChild(option);
        }
        if ([...modelSelect.options].some((item) => item.value === current)) {
            modelSelect.value = current;
        } else {
            modelSelect.value = "";
        }
        modelHidden.value = modelSelect.value || "";
    }

    engineSelect.addEventListener("change", () => {
        renderProviders();
        renderModels();
    });
    providerSelect.addEventListener("change", () => {
        renderModels();
    });
    modelSelect.addEventListener("change", () => {
        modelHidden.value = modelSelect.value || "";
    });

    renderProviders();
    renderModels();
})();
</script>
{% endblock %}
